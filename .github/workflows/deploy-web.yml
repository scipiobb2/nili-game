name: Build & Deploy Web

on:
  push:
    tags:
      - "v*"

env:
  GODOT_VERSION: 4.5.1
  EXPORT_PRESET: Web
  PROJECT_PATH: game
  EXPORT_DIR: game/build/web
  RELEASE_VERSION: ""

permissions:
  contents: write

jobs:
  web:
    runs-on: ubuntu-latest
    container: barichello/godot-ci:4.5.1

    steps:
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Require CI to have succeeded for this commit
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            const workflowId = 'ci.yml';

            const { data } = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowId,
              head_sha: sha,
              per_page: 1,
            });

            const run = data.workflow_runs[0];
            if (!run) {
              core.setFailed(`No CI workflow run found for commit ${sha}. Run CI on the commit before tagging a release.`);
              return;
            }

            if (run.status !== 'completed' || run.conclusion !== 'success') {
              core.setFailed(`CI workflow run for ${sha} is not successful (status: ${run.status}, conclusion: ${run.conclusion}). Tag only after CI passes.`);
            }

      - name: Derive release version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "RELEASE_VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Show release version
        run: echo "Releasing version ${RELEASE_VERSION} from tag ${GITHUB_REF_NAME}"

      # Godot sometimes touches editor caches even in --headless.
      # Using fresh XDG dirs reduces flaky crashes and "doc cache" behavior.
      - name: Use clean Godot user dirs
        run: |
          echo "XDG_CONFIG_HOME=$GITHUB_WORKSPACE/.xdg/config" >> $GITHUB_ENV
          echo "XDG_CACHE_HOME=$GITHUB_WORKSPACE/.xdg/cache" >> $GITHUB_ENV
          echo "XDG_DATA_HOME=$GITHUB_WORKSPACE/.xdg/data" >> $GITHUB_ENV

      # Fix: libfontconfig.so.1 missing in the container â†’ can destabilize editor/theme init.
      - name: Install runtime deps
        run: |
          apt-get update
          apt-get install -y --no-install-recommends fontconfig libfontconfig1
          fc-cache -f -v || true

      # CRITICAL FIX HERE:
      # We move templates into the CUSTOM XDG path defined above, not the default path.
      - name: Setup export templates
        run: |
          # Create the folder inside your custom .xdg/data directory
          mkdir -p "$XDG_DATA_HOME/godot/export_templates"
          
          # Move templates from the container default to your custom location
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable \
             "$XDG_DATA_HOME/godot/export_templates/${GODOT_VERSION}.stable"

      - name: Ensure export folder exists
        run: |
          mkdir -p "${EXPORT_DIR}"

      # Disable the git plugin in project.godot to prevent "nullptr VCS" errors during export.
      # This is safer than just ignoring the folder.
      - name: Disable Git Plugin for CI
        run: |
          if [ -f "${PROJECT_PATH}/project.godot" ]; then
            sed -i 's/godot-git-plugin=true/godot-git-plugin=false/' "${PROJECT_PATH}/project.godot" || true
          fi

      - name: Exclude editor-only git plugin from export (CI only)
        run: |
          if [ -d "${PROJECT_PATH}/addons/godot-git-plugin" ]; then
            touch "${PROJECT_PATH}/addons/godot-git-plugin/.gdignore"
          fi

      - name: Set project version from tag
        run: |
          if [ -z "${RELEASE_VERSION}" ]; then
            echo "Release version could not be derived from tag ${GITHUB_REF_NAME}" >&2
            exit 1
          fi

          PROJECT_FILE="${PROJECT_PATH}/project.godot"
          if grep -q '^config/version=' "$PROJECT_FILE"; then
            sed -i "s/^config\/version=.*/config\/version=\"${RELEASE_VERSION}\"/" "$PROJECT_FILE"
          else
            if ! grep -q '^\[application\]' "$PROJECT_FILE"; then
              echo "[application] section not found in ${PROJECT_FILE}" >&2
              exit 1
            fi

            awk -v ver="$RELEASE_VERSION" '
              BEGIN { inserted = 0 }
              /^\[application\]$/ {
                print
                print "config/version=\"" ver "\""
                inserted = 1
                next
              }
              { print }
              END {
                if (inserted == 0) {
                  exit 1
                }
              }
            ' "$PROJECT_FILE" >"${PROJECT_FILE}.tmp" && mv "${PROJECT_FILE}.tmp" "$PROJECT_FILE"
          fi

      - name: Prepare artifact folders
        run: |
          mkdir -p artifacts/logs artifacts/web_export

      - name: Export Web
        run: |
          set -o pipefail
          godot --headless --verbose --path "${PROJECT_PATH}" \
                --export-release "${EXPORT_PRESET}" 2>&1 | tee artifacts/logs/export.log

      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: game/build/web
          clean: true
        if: success()

      - name: Tar web export for debugging
        if: always()
        run: |
          if [ -d "${EXPORT_DIR}" ] && [ "$(ls -A ${EXPORT_DIR})" ]; then
            tar -czf artifacts/web_export/web-export.tar.gz -C "${EXPORT_DIR}" .
          fi

      - name: Upload export logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: export-logs
          path: artifacts/logs/export.log
          retention-days: 7

      - name: Upload web export artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-export
          path: artifacts/web_export/web-export.tar.gz
          if-no-files-found: ignore
          retention-days: 7
