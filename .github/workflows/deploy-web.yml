name: Build & Deploy Web

on:
  push:
    branches: [ main ]

env:
  GODOT_VERSION: 4.5.1
  EXPORT_PRESET: Web
  PROJECT_PATH: game
  EXPORT_DIR: game/build/web

permissions:
  contents: write

jobs:
  web:
    runs-on: ubuntu-latest
    container: barichello/godot-ci:4.5.1

    steps:
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      # Godot sometimes touches editor caches even in --headless.
      # Using fresh XDG dirs reduces flaky crashes and "doc cache" behavior.
      - name: Use clean Godot user dirs
        run: |
          echo "XDG_CONFIG_HOME=$GITHUB_WORKSPACE/.xdg/config" >> $GITHUB_ENV
          echo "XDG_CACHE_HOME=$GITHUB_WORKSPACE/.xdg/cache" >> $GITHUB_ENV
          echo "XDG_DATA_HOME=$GITHUB_WORKSPACE/.xdg/data" >> $GITHUB_ENV

      # Fix: libfontconfig.so.1 missing in the container â†’ can destabilize editor/theme init.
      - name: Install runtime deps
        run: |
          apt-get update
          apt-get install -y --no-install-recommends fontconfig libfontconfig1
          fc-cache -f -v || true

      # godot-ci ships templates in /root; Godot expects them in the user's export_templates dir.
      - name: Setup export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable \
             ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      # Your Web preset expects res://build/web to exist (res:// is PROJECT_PATH).
      - name: Ensure export folder exists
        run: |
          mkdir -p "${EXPORT_DIR}"

      # Keep the plugin for local dev, but do not ship it in Web export.
      # .gdignore makes Godot ignore the folder in this CI run only.
      - name: Exclude editor-only git plugin from export (CI only)
        run: |
          if [ -d "${PROJECT_PATH}/addons/godot-git-plugin" ]; then
            touch "${PROJECT_PATH}/addons/godot-git-plugin/.gdignore"
          fi

      # Export using the preset path defined in export_presets.cfg
      - name: Export Web
        run: |
          godot --headless --verbose --path "${PROJECT_PATH}" \
                --export-release "${EXPORT_PRESET}"

      # Deploy to GitHub Pages via gh-pages branch
      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: game/build/web
          clean: true

