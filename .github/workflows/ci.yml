name: CI

on:
  pull_request:
  push:
    branches: [ main ]

defaults:
  run:
    shell: bash
    
env:
  GODOT_VERSION: 4.5.1
  PROJECT_PATH: game

jobs:
  tests:
    runs-on: ubuntu-latest
    container: barichello/godot-ci:4.5.1

    steps:
      - name: Checkout repo (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Enforce GDScript tabs-only indentation
        run: |
          set -euo pipefail
          # Match any NON-empty line whose leading indentation contains at least one space.
          # (Tabs are allowed; spaces in the indentation prefix are not.)
          pattern=$'^[\t ]* [\t ]*[^ \t]'
          offenders=$(grep -nR --include='*.gd' --include='*.gdshader' -E "$pattern" "${PROJECT_PATH}" || true)
          if [ -n "$offenders" ]; then
            echo "ERROR: Found space characters in leading indentation in GDScript. Use tabs only."
            echo
            echo "$offenders"
            echo
            echo "Fix: convert indentation to tabs in Godot (Edit -> Convert Indent to Tabs) or your editor."
            exit 1
          fi

      # Use clean Godot user dirs to avoid cached state impacting tests.
      - name: Use clean Godot user dirs
        run: |
          echo "XDG_CONFIG_HOME=$GITHUB_WORKSPACE/.xdg/config" >> $GITHUB_ENV
          echo "XDG_CACHE_HOME=$GITHUB_WORKSPACE/.xdg/cache" >> $GITHUB_ENV
          echo "XDG_DATA_HOME=$GITHUB_WORKSPACE/.xdg/data" >> $GITHUB_ENV

      # Ensure font config is present; missing libfontconfig can break headless init.
      - name: Install runtime deps
        run: |
          apt-get update
          apt-get install -y --no-install-recommends fontconfig libfontconfig1
          fc-cache -f -v || true

      - name: Run headless tests
        working-directory: ${{ env.PROJECT_PATH }}
        run: ./run_tests.sh
